

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>patsy.categorical &mdash; Patsy API v1</title>
  

  
  

  

  
  
    

  

  
  
    <link rel="stylesheet" href="../../_static/css/theme.css" type="text/css" />
  

  

  
    <link rel="top" title="Patsy API v1" href="../../index.html"/>
        <link rel="up" title="patsy" href="../patsy.html"/> 

  
  <script src="../../_static/js/modernizr.min.js"></script>

</head>

<body class="wy-body-for-nav" role="document">

   
  <div class="wy-grid-for-nav">

    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search">
          

          
            <a href="../../index.html" class="icon icon-home"> Patsy API
          

          
          </a>

          
            
            
              <div class="version">
                1
              </div>
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
                <p class="caption"><span class="caption-text">Table of Contents</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../generated/patsy.html">1. patsy</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../generated/patsy.builtins.html">2. patsy.builtins</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../generated/patsy.categorical.html">3. patsy.categorical</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../generated/patsy.infix_parser.html">4. patsy.infix_parser</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../generated/patsy.parse_formula.html">5. patsy.parse_formula</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../generated/patsy.tokens.html">6. patsy.tokens</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../generated/patsy.util.html">7. patsy.util</a></li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" role="navigation" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../index.html">Patsy API</a>
        
      </nav>


      
      <div class="wy-nav-content">
        <div class="rst-content">
          













<div role="navigation" aria-label="breadcrumbs navigation">
  <ul class="wy-breadcrumbs">
    
      <li><a href="../../index.html">Docs</a> &raquo;</li>
        
          <li><a href="../index.html">Module code</a> &raquo;</li>
        
          <li><a href="../patsy.html">patsy</a> &raquo;</li>
        
      <li>patsy.categorical</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
            
        
      </li>
    
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <h1>Source code for patsy.categorical</h1><div class="highlight"><pre>
<span></span><span class="c1"># This file is part of Patsy</span>
<span class="c1"># Copyright (C) 2011-2013 Nathaniel Smith &lt;njs@pobox.com&gt;</span>
<span class="c1"># See file LICENSE.txt for license information.</span>

<span class="n">__all__</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;C&quot;</span><span class="p">,</span> <span class="s2">&quot;guess_categorical&quot;</span><span class="p">,</span> <span class="s2">&quot;CategoricalSniffer&quot;</span><span class="p">,</span>
           <span class="s2">&quot;categorical_to_int&quot;</span><span class="p">]</span>

<span class="c1"># How we handle categorical data: the big picture</span>
<span class="c1"># -----------------------------------------------</span>
<span class="c1">#</span>
<span class="c1"># There is no Python/NumPy standard for how to represent categorical data.</span>
<span class="c1"># There is no Python/NumPy standard for how to represent missing data.</span>
<span class="c1">#</span>
<span class="c1"># Together, these facts mean that when we receive some data object, we must be</span>
<span class="c1"># able to heuristically infer what levels it has -- and this process must be</span>
<span class="c1"># sensitive to the current missing data handling, because maybe &#39;None&#39; is a</span>
<span class="c1"># level and maybe it is missing data.</span>
<span class="c1">#</span>
<span class="c1"># We don&#39;t know how missing data is represented until we get into the actual</span>
<span class="c1"># builder code, so anything which runs before this -- e.g., the &#39;C()&#39; builtin</span>
<span class="c1"># -- cannot actually do *anything* meaningful with the data.</span>
<span class="c1">#</span>
<span class="c1"># Therefore, C() simply takes some data and arguments, and boxes them all up</span>
<span class="c1"># together into an object called (appropriately enough) _CategoricalBox. All</span>
<span class="c1"># the actual work of handling the various different sorts of categorical data</span>
<span class="c1"># (lists, string arrays, bool arrays, pandas.Categorical, etc.) happens inside</span>
<span class="c1"># the builder code, and we just extend this so that it also accepts</span>
<span class="c1"># _CategoricalBox objects as yet another categorical type.</span>
<span class="c1">#</span>
<span class="c1"># Originally this file contained a container type (called &#39;Categorical&#39;), and</span>
<span class="c1"># the various sniffing, conversion, etc., functions were written as methods on</span>
<span class="c1"># that type. But we had to get rid of that type, so now this file just</span>
<span class="c1"># provides a set of plain old functions which are used by patsy.build to</span>
<span class="c1"># handle the different stages of categorical data munging.</span>

<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">six</span>
<span class="kn">from</span> <span class="nn">patsy</span> <span class="k">import</span> <span class="n">PatsyError</span>
<span class="kn">from</span> <span class="nn">patsy.util</span> <span class="k">import</span> <span class="p">(</span><span class="n">SortAnythingKey</span><span class="p">,</span>
                        <span class="n">safe_scalar_isnan</span><span class="p">,</span>
                        <span class="n">iterable</span><span class="p">,</span>
                        <span class="n">have_pandas</span><span class="p">,</span> <span class="n">have_pandas_categorical</span><span class="p">,</span>
                        <span class="n">have_pandas_categorical_dtype</span><span class="p">,</span>
                        <span class="n">safe_is_pandas_categorical</span><span class="p">,</span>
                        <span class="n">pandas_Categorical_from_codes</span><span class="p">,</span>
                        <span class="n">pandas_Categorical_categories</span><span class="p">,</span>
                        <span class="n">pandas_Categorical_codes</span><span class="p">,</span>
                        <span class="n">safe_issubdtype</span><span class="p">,</span>
                        <span class="n">no_pickling</span><span class="p">,</span> <span class="n">assert_no_pickling</span><span class="p">)</span>

<span class="k">if</span> <span class="n">have_pandas</span><span class="p">:</span>
    <span class="kn">import</span> <span class="nn">pandas</span>

<span class="c1"># Objects of this type will always be treated as categorical, with the</span>
<span class="c1"># specified levels and contrast (if given).</span>
<span class="k">class</span> <span class="nc">_CategoricalBox</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">contrast</span><span class="p">,</span> <span class="n">levels</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">data</span> <span class="o">=</span> <span class="n">data</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">contrast</span> <span class="o">=</span> <span class="n">contrast</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">levels</span> <span class="o">=</span> <span class="n">levels</span>

    <span class="n">__getstate__</span> <span class="o">=</span> <span class="n">no_pickling</span>

<div class="viewcode-block" id="C"><a class="viewcode-back" href="../../generated/patsy.categorical.C.html#patsy.categorical.C">[docs]</a><span class="k">def</span> <span class="nf">C</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">contrast</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">levels</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Marks some `data` as being categorical, and specifies how to interpret</span>
<span class="sd">    it.</span>

<span class="sd">    This is used for three reasons:</span>

<span class="sd">    * To explicitly mark some data as categorical. For instance, integer data</span>
<span class="sd">      is by default treated as numerical. If you have data that is stored</span>
<span class="sd">      using an integer type, but where you want patsy to treat each different</span>
<span class="sd">      value as a different level of a categorical factor, you can wrap it in a</span>
<span class="sd">      call to `C` to accomplish this. E.g., compare::</span>

<span class="sd">        dmatrix(&quot;a&quot;, {&quot;a&quot;: [1, 2, 3]})</span>
<span class="sd">        dmatrix(&quot;C(a)&quot;, {&quot;a&quot;: [1, 2, 3]})</span>

<span class="sd">    * To explicitly set the levels or override the default level ordering for</span>
<span class="sd">      categorical data, e.g.::</span>

<span class="sd">        dmatrix(&quot;C(a, levels=[&quot;a2&quot;, &quot;a1&quot;])&quot;, balanced(a=2))</span>
<span class="sd">    * To override the default coding scheme for categorical data. The</span>
<span class="sd">      `contrast` argument can be any of:</span>

<span class="sd">      * A :class:`ContrastMatrix` object</span>
<span class="sd">      * A simple 2d ndarray (which is treated the same as a ContrastMatrix</span>
<span class="sd">        object except that you can&#39;t specify column names)</span>
<span class="sd">      * An object with methods called `code_with_intercept` and</span>
<span class="sd">        `code_without_intercept`, like the built-in contrasts</span>
<span class="sd">        (:class:`Treatment`, :class:`Diff`, :class:`Poly`, etc.). See</span>
<span class="sd">        :ref:`categorical-coding` for more details.</span>
<span class="sd">      * A callable that returns one of the above.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">_CategoricalBox</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">contrast</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">contrast</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">contrast</span>
        <span class="k">if</span> <span class="n">levels</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">levels</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">levels</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">data</span>
    <span class="k">return</span> <span class="n">_CategoricalBox</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">contrast</span><span class="p">,</span> <span class="n">levels</span><span class="p">)</span></div>

<div class="viewcode-block" id="test_C"><a class="viewcode-back" href="../../generated/patsy.categorical.test_C.html#patsy.categorical.test_C">[docs]</a><span class="k">def</span> <span class="nf">test_C</span><span class="p">():</span>
    <span class="n">c1</span> <span class="o">=</span> <span class="n">C</span><span class="p">(</span><span class="s2">&quot;asdf&quot;</span><span class="p">)</span>
    <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">c1</span><span class="p">,</span> <span class="n">_CategoricalBox</span><span class="p">)</span>
    <span class="k">assert</span> <span class="n">c1</span><span class="o">.</span><span class="n">data</span> <span class="o">==</span> <span class="s2">&quot;asdf&quot;</span>
    <span class="k">assert</span> <span class="n">c1</span><span class="o">.</span><span class="n">levels</span> <span class="ow">is</span> <span class="kc">None</span>
    <span class="k">assert</span> <span class="n">c1</span><span class="o">.</span><span class="n">contrast</span> <span class="ow">is</span> <span class="kc">None</span>
    <span class="n">c2</span> <span class="o">=</span> <span class="n">C</span><span class="p">(</span><span class="s2">&quot;DATA&quot;</span><span class="p">,</span> <span class="s2">&quot;CONTRAST&quot;</span><span class="p">,</span> <span class="s2">&quot;LEVELS&quot;</span><span class="p">)</span>
    <span class="k">assert</span> <span class="n">c2</span><span class="o">.</span><span class="n">data</span> <span class="o">==</span> <span class="s2">&quot;DATA&quot;</span>
    <span class="k">assert</span> <span class="n">c2</span><span class="o">.</span><span class="n">contrast</span> <span class="o">==</span> <span class="s2">&quot;CONTRAST&quot;</span>
    <span class="k">assert</span> <span class="n">c2</span><span class="o">.</span><span class="n">levels</span> <span class="o">==</span> <span class="s2">&quot;LEVELS&quot;</span>
    <span class="n">c3</span> <span class="o">=</span> <span class="n">C</span><span class="p">(</span><span class="n">c2</span><span class="p">,</span> <span class="n">levels</span><span class="o">=</span><span class="s2">&quot;NEW LEVELS&quot;</span><span class="p">)</span>
    <span class="k">assert</span> <span class="n">c3</span><span class="o">.</span><span class="n">data</span> <span class="o">==</span> <span class="s2">&quot;DATA&quot;</span>
    <span class="k">assert</span> <span class="n">c3</span><span class="o">.</span><span class="n">contrast</span> <span class="o">==</span> <span class="s2">&quot;CONTRAST&quot;</span>
    <span class="k">assert</span> <span class="n">c3</span><span class="o">.</span><span class="n">levels</span> <span class="o">==</span> <span class="s2">&quot;NEW LEVELS&quot;</span>
    <span class="n">c4</span> <span class="o">=</span> <span class="n">C</span><span class="p">(</span><span class="n">c2</span><span class="p">,</span> <span class="s2">&quot;NEW CONTRAST&quot;</span><span class="p">)</span>
    <span class="k">assert</span> <span class="n">c4</span><span class="o">.</span><span class="n">data</span> <span class="o">==</span> <span class="s2">&quot;DATA&quot;</span>
    <span class="k">assert</span> <span class="n">c4</span><span class="o">.</span><span class="n">contrast</span> <span class="o">==</span> <span class="s2">&quot;NEW CONTRAST&quot;</span>
    <span class="k">assert</span> <span class="n">c4</span><span class="o">.</span><span class="n">levels</span> <span class="o">==</span> <span class="s2">&quot;LEVELS&quot;</span>

    <span class="n">assert_no_pickling</span><span class="p">(</span><span class="n">c4</span><span class="p">)</span></div>

<div class="viewcode-block" id="guess_categorical"><a class="viewcode-back" href="../../generated/patsy.categorical.guess_categorical.html#patsy.categorical.guess_categorical">[docs]</a><span class="k">def</span> <span class="nf">guess_categorical</span><span class="p">(</span><span class="n">data</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">safe_is_pandas_categorical</span><span class="p">(</span><span class="n">data</span><span class="p">):</span>
        <span class="k">return</span> <span class="kc">True</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">_CategoricalBox</span><span class="p">):</span>
        <span class="k">return</span> <span class="kc">True</span>
    <span class="n">data</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">safe_issubdtype</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">dtype</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">number</span><span class="p">):</span>
        <span class="k">return</span> <span class="kc">False</span>
    <span class="k">return</span> <span class="kc">True</span></div>

<div class="viewcode-block" id="test_guess_categorical"><a class="viewcode-back" href="../../generated/patsy.categorical.test_guess_categorical.html#patsy.categorical.test_guess_categorical">[docs]</a><span class="k">def</span> <span class="nf">test_guess_categorical</span><span class="p">():</span>
    <span class="k">if</span> <span class="n">have_pandas_categorical</span><span class="p">:</span>
        <span class="n">c</span> <span class="o">=</span> <span class="n">pandas</span><span class="o">.</span><span class="n">Categorical</span><span class="o">.</span><span class="n">from_array</span><span class="p">([</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">])</span>
        <span class="k">assert</span> <span class="n">guess_categorical</span><span class="p">(</span><span class="n">c</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">have_pandas_categorical_dtype</span><span class="p">:</span>
            <span class="k">assert</span> <span class="n">guess_categorical</span><span class="p">(</span><span class="n">pandas</span><span class="o">.</span><span class="n">Series</span><span class="p">(</span><span class="n">c</span><span class="p">))</span>
    <span class="k">assert</span> <span class="n">guess_categorical</span><span class="p">(</span><span class="n">C</span><span class="p">([</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">]))</span>
    <span class="k">assert</span> <span class="n">guess_categorical</span><span class="p">([</span><span class="kc">True</span><span class="p">,</span> <span class="kc">False</span><span class="p">])</span>
    <span class="k">assert</span> <span class="n">guess_categorical</span><span class="p">([</span><span class="s2">&quot;a&quot;</span><span class="p">,</span> <span class="s2">&quot;b&quot;</span><span class="p">])</span>
    <span class="k">assert</span> <span class="n">guess_categorical</span><span class="p">([</span><span class="s2">&quot;a&quot;</span><span class="p">,</span> <span class="s2">&quot;b&quot;</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">])</span>
    <span class="k">assert</span> <span class="n">guess_categorical</span><span class="p">([</span><span class="s2">&quot;a&quot;</span><span class="p">,</span> <span class="s2">&quot;b&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">])</span>
    <span class="k">assert</span> <span class="ow">not</span> <span class="n">guess_categorical</span><span class="p">([</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">])</span>
    <span class="k">assert</span> <span class="ow">not</span> <span class="n">guess_categorical</span><span class="p">([</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">])</span>
    <span class="k">assert</span> <span class="ow">not</span> <span class="n">guess_categorical</span><span class="p">([</span><span class="mf">1.0</span><span class="p">,</span> <span class="mf">2.0</span><span class="p">,</span> <span class="mf">3.0</span><span class="p">])</span>
    <span class="k">assert</span> <span class="ow">not</span> <span class="n">guess_categorical</span><span class="p">([</span><span class="mf">1.0</span><span class="p">,</span> <span class="mf">2.0</span><span class="p">,</span> <span class="mf">3.0</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">])</span></div>

<span class="k">def</span> <span class="nf">_categorical_shape_fix</span><span class="p">(</span><span class="n">data</span><span class="p">):</span>
    <span class="c1"># helper function</span>
    <span class="c1"># data should not be a _CategoricalBox or pandas Categorical or anything</span>
    <span class="c1"># -- it should be an actual iterable of data, but which might have the</span>
    <span class="c1"># wrong shape.</span>
    <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="s2">&quot;ndim&quot;</span><span class="p">)</span> <span class="ow">and</span> <span class="n">data</span><span class="o">.</span><span class="n">ndim</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
        <span class="k">raise</span> <span class="n">PatsyError</span><span class="p">(</span><span class="s2">&quot;categorical data cannot be &gt;1-dimensional&quot;</span><span class="p">)</span>
    <span class="c1"># coerce scalars into 1d, which is consistent with what we do for numeric</span>
    <span class="c1"># factors. (See statsmodels/statsmodels#1881)</span>
    <span class="k">if</span> <span class="p">(</span><span class="ow">not</span> <span class="n">iterable</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
        <span class="ow">or</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="p">(</span><span class="n">six</span><span class="o">.</span><span class="n">text_type</span><span class="p">,</span> <span class="n">six</span><span class="o">.</span><span class="n">binary_type</span><span class="p">))):</span>
        <span class="n">data</span> <span class="o">=</span> <span class="p">[</span><span class="n">data</span><span class="p">]</span>
    <span class="k">return</span> <span class="n">data</span>

<div class="viewcode-block" id="CategoricalSniffer"><a class="viewcode-back" href="../../generated/generated/patsy.categorical.CategoricalSniffer.html#patsy.categorical.CategoricalSniffer">[docs]</a><span class="k">class</span> <span class="nc">CategoricalSniffer</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
<div class="viewcode-block" id="CategoricalSniffer.__init__"><a class="viewcode-back" href="../../generated/generated/patsy.categorical.CategoricalSniffer.__init__.html#patsy.categorical.CategoricalSniffer.__init__">[docs]</a>    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">NA_action</span><span class="p">,</span> <span class="n">origin</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_NA_action</span> <span class="o">=</span> <span class="n">NA_action</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_origin</span> <span class="o">=</span> <span class="n">origin</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_contrast</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_levels</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_level_set</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span></div>

<div class="viewcode-block" id="CategoricalSniffer.levels_contrast"><a class="viewcode-back" href="../../generated/generated/patsy.categorical.CategoricalSniffer.levels_contrast.html#patsy.categorical.CategoricalSniffer.levels_contrast">[docs]</a>    <span class="k">def</span> <span class="nf">levels_contrast</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_levels</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">levels</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_level_set</span><span class="p">)</span>
            <span class="n">levels</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="n">key</span><span class="o">=</span><span class="n">SortAnythingKey</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_levels</span> <span class="o">=</span> <span class="n">levels</span>
        <span class="k">return</span> <span class="nb">tuple</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_levels</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">_contrast</span></div>

<div class="viewcode-block" id="CategoricalSniffer.sniff"><a class="viewcode-back" href="../../generated/generated/patsy.categorical.CategoricalSniffer.sniff.html#patsy.categorical.CategoricalSniffer.sniff">[docs]</a>    <span class="k">def</span> <span class="nf">sniff</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">):</span>
        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="s2">&quot;contrast&quot;</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_contrast</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">contrast</span>
        <span class="c1"># returns a bool: are we confident that we found all the levels?</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">_CategoricalBox</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">data</span><span class="o">.</span><span class="n">levels</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_levels</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">levels</span><span class="p">)</span>
                <span class="k">return</span> <span class="kc">True</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># unbox and fall through</span>
                <span class="n">data</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">data</span>
        <span class="k">if</span> <span class="n">safe_is_pandas_categorical</span><span class="p">(</span><span class="n">data</span><span class="p">):</span>
            <span class="c1"># pandas.Categorical has its own NA detection, so don&#39;t try to</span>
            <span class="c1"># second-guess it.</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_levels</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">pandas_Categorical_categories</span><span class="p">(</span><span class="n">data</span><span class="p">))</span>
            <span class="k">return</span> <span class="kc">True</span>
        <span class="c1"># fastpath to avoid doing an item-by-item iteration over boolean</span>
        <span class="c1"># arrays, as requested by #44</span>
        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="s2">&quot;dtype&quot;</span><span class="p">)</span> <span class="ow">and</span> <span class="n">safe_issubdtype</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">dtype</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">bool_</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_level_set</span> <span class="o">=</span> <span class="nb">set</span><span class="p">([</span><span class="kc">True</span><span class="p">,</span> <span class="kc">False</span><span class="p">])</span>
            <span class="k">return</span> <span class="kc">True</span>

        <span class="n">data</span> <span class="o">=</span> <span class="n">_categorical_shape_fix</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">data</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_NA_action</span><span class="o">.</span><span class="n">is_categorical_NA</span><span class="p">(</span><span class="n">value</span><span class="p">):</span>
                <span class="k">continue</span>
            <span class="k">if</span> <span class="n">value</span> <span class="ow">is</span> <span class="kc">True</span> <span class="ow">or</span> <span class="n">value</span> <span class="ow">is</span> <span class="kc">False</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_level_set</span><span class="o">.</span><span class="n">update</span><span class="p">([</span><span class="kc">True</span><span class="p">,</span> <span class="kc">False</span><span class="p">])</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_level_set</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
                <span class="k">except</span> <span class="ne">TypeError</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="n">PatsyError</span><span class="p">(</span><span class="s2">&quot;Error interpreting categorical data: &quot;</span>
                                     <span class="s2">&quot;all items must be hashable&quot;</span><span class="p">,</span>
                                     <span class="bp">self</span><span class="o">.</span><span class="n">_origin</span><span class="p">)</span>
        <span class="c1"># If everything we&#39;ve seen is boolean, assume that everything else</span>
        <span class="c1"># would be too. Otherwise we need to keep looking.</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_level_set</span> <span class="o">==</span> <span class="nb">set</span><span class="p">([</span><span class="kc">True</span><span class="p">,</span> <span class="kc">False</span><span class="p">])</span></div>

    <span class="n">__getstate__</span> <span class="o">=</span> <span class="n">no_pickling</span></div>

<div class="viewcode-block" id="test_CategoricalSniffer"><a class="viewcode-back" href="../../generated/patsy.categorical.test_CategoricalSniffer.html#patsy.categorical.test_CategoricalSniffer">[docs]</a><span class="k">def</span> <span class="nf">test_CategoricalSniffer</span><span class="p">():</span>
    <span class="kn">from</span> <span class="nn">patsy.missing</span> <span class="k">import</span> <span class="n">NAAction</span>
    <span class="k">def</span> <span class="nf">t</span><span class="p">(</span><span class="n">NA_types</span><span class="p">,</span> <span class="n">datas</span><span class="p">,</span> <span class="n">exp_finish_fast</span><span class="p">,</span> <span class="n">exp_levels</span><span class="p">,</span> <span class="n">exp_contrast</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="n">sniffer</span> <span class="o">=</span> <span class="n">CategoricalSniffer</span><span class="p">(</span><span class="n">NAAction</span><span class="p">(</span><span class="n">NA_types</span><span class="o">=</span><span class="n">NA_types</span><span class="p">))</span>
        <span class="k">for</span> <span class="n">data</span> <span class="ow">in</span> <span class="n">datas</span><span class="p">:</span>
            <span class="n">done</span> <span class="o">=</span> <span class="n">sniffer</span><span class="o">.</span><span class="n">sniff</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">done</span><span class="p">:</span>
                <span class="k">assert</span> <span class="n">exp_finish_fast</span>
                <span class="k">break</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">assert</span> <span class="ow">not</span> <span class="n">exp_finish_fast</span>
        <span class="k">assert</span> <span class="n">sniffer</span><span class="o">.</span><span class="n">levels_contrast</span><span class="p">()</span> <span class="o">==</span> <span class="p">(</span><span class="n">exp_levels</span><span class="p">,</span> <span class="n">exp_contrast</span><span class="p">)</span>
    
    <span class="k">if</span> <span class="n">have_pandas_categorical</span><span class="p">:</span>
        <span class="c1"># We make sure to test with both boxed and unboxed pandas objects,</span>
        <span class="c1"># because we used to have a bug where boxed pandas objects would be</span>
        <span class="c1"># treated as categorical, but their levels would be lost...</span>
        <span class="n">preps</span> <span class="o">=</span> <span class="p">[</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="p">,</span>
                 <span class="n">C</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">have_pandas_categorical_dtype</span><span class="p">:</span>
            <span class="n">preps</span> <span class="o">+=</span> <span class="p">[</span><span class="n">pandas</span><span class="o">.</span><span class="n">Series</span><span class="p">,</span>
                      <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">C</span><span class="p">(</span><span class="n">pandas</span><span class="o">.</span><span class="n">Series</span><span class="p">(</span><span class="n">x</span><span class="p">))]</span>
        <span class="k">for</span> <span class="n">prep</span> <span class="ow">in</span> <span class="n">preps</span><span class="p">:</span>
            <span class="n">t</span><span class="p">([],</span> <span class="p">[</span><span class="n">prep</span><span class="p">(</span><span class="n">pandas</span><span class="o">.</span><span class="n">Categorical</span><span class="o">.</span><span class="n">from_array</span><span class="p">([</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="kc">None</span><span class="p">]))],</span>
              <span class="kc">True</span><span class="p">,</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">))</span>
            <span class="c1"># check order preservation</span>
            <span class="n">t</span><span class="p">([],</span> <span class="p">[</span><span class="n">prep</span><span class="p">(</span><span class="n">pandas_Categorical_from_codes</span><span class="p">([</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span> <span class="p">[</span><span class="s2">&quot;a&quot;</span><span class="p">,</span> <span class="s2">&quot;b&quot;</span><span class="p">]))],</span>
              <span class="kc">True</span><span class="p">,</span> <span class="p">(</span><span class="s2">&quot;a&quot;</span><span class="p">,</span> <span class="s2">&quot;b&quot;</span><span class="p">))</span>
            <span class="n">t</span><span class="p">([],</span> <span class="p">[</span><span class="n">prep</span><span class="p">(</span><span class="n">pandas_Categorical_from_codes</span><span class="p">([</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span> <span class="p">[</span><span class="s2">&quot;b&quot;</span><span class="p">,</span> <span class="s2">&quot;a&quot;</span><span class="p">]))],</span>
              <span class="kc">True</span><span class="p">,</span> <span class="p">(</span><span class="s2">&quot;b&quot;</span><span class="p">,</span> <span class="s2">&quot;a&quot;</span><span class="p">))</span>
            <span class="c1"># check that if someone sticks a .contrast field onto our object</span>
            <span class="n">obj</span> <span class="o">=</span> <span class="n">prep</span><span class="p">(</span><span class="n">pandas</span><span class="o">.</span><span class="n">Categorical</span><span class="o">.</span><span class="n">from_array</span><span class="p">([</span><span class="s2">&quot;a&quot;</span><span class="p">,</span> <span class="s2">&quot;b&quot;</span><span class="p">]))</span>
            <span class="n">obj</span><span class="o">.</span><span class="n">contrast</span> <span class="o">=</span> <span class="s2">&quot;CONTRAST&quot;</span>
            <span class="n">t</span><span class="p">([],</span> <span class="p">[</span><span class="n">obj</span><span class="p">],</span> <span class="kc">True</span><span class="p">,</span> <span class="p">(</span><span class="s2">&quot;a&quot;</span><span class="p">,</span> <span class="s2">&quot;b&quot;</span><span class="p">),</span> <span class="s2">&quot;CONTRAST&quot;</span><span class="p">)</span>

    <span class="n">t</span><span class="p">([],</span> <span class="p">[</span><span class="n">C</span><span class="p">([</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">]),</span> <span class="n">C</span><span class="p">([</span><span class="mi">3</span><span class="p">,</span> <span class="mi">2</span><span class="p">])],</span> <span class="kc">False</span><span class="p">,</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">))</span>
    <span class="c1"># check order preservation</span>
    <span class="n">t</span><span class="p">([],</span> <span class="p">[</span><span class="n">C</span><span class="p">([</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">],</span> <span class="n">levels</span><span class="o">=</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">]),</span> <span class="n">C</span><span class="p">([</span><span class="mi">4</span><span class="p">,</span> <span class="mi">2</span><span class="p">])],</span> <span class="kc">True</span><span class="p">,</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">))</span>
    <span class="n">t</span><span class="p">([],</span> <span class="p">[</span><span class="n">C</span><span class="p">([</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">],</span> <span class="n">levels</span><span class="o">=</span><span class="p">[</span><span class="mi">3</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">]),</span> <span class="n">C</span><span class="p">([</span><span class="mi">4</span><span class="p">,</span> <span class="mi">2</span><span class="p">])],</span> <span class="kc">True</span><span class="p">,</span> <span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>

    <span class="c1"># do some actual sniffing with NAs in</span>
    <span class="n">t</span><span class="p">([</span><span class="s2">&quot;None&quot;</span><span class="p">,</span> <span class="s2">&quot;NaN&quot;</span><span class="p">],</span> <span class="p">[</span><span class="n">C</span><span class="p">([</span><span class="mi">1</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">]),</span> <span class="n">C</span><span class="p">([</span><span class="mi">10</span><span class="p">,</span> <span class="kc">None</span><span class="p">])],</span>
      <span class="kc">False</span><span class="p">,</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">10</span><span class="p">))</span>
    <span class="c1"># But &#39;None&#39; can be a type if we don&#39;t make it represent NA:</span>
    <span class="n">sniffer</span> <span class="o">=</span> <span class="n">CategoricalSniffer</span><span class="p">(</span><span class="n">NAAction</span><span class="p">(</span><span class="n">NA_types</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;NaN&quot;</span><span class="p">]))</span>
    <span class="n">sniffer</span><span class="o">.</span><span class="n">sniff</span><span class="p">(</span><span class="n">C</span><span class="p">([</span><span class="mi">1</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">,</span> <span class="kc">None</span><span class="p">]))</span>
    <span class="c1"># The level order here is different on py2 and py3 :-( Because there&#39;s no</span>
    <span class="c1"># consistent way to sort mixed-type values on both py2 and py3. Honestly</span>
    <span class="c1"># people probably shouldn&#39;t use this, but I don&#39;t know how to give a</span>
    <span class="c1"># sensible error.</span>
    <span class="n">levels</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">sniffer</span><span class="o">.</span><span class="n">levels_contrast</span><span class="p">()</span>
    <span class="k">assert</span> <span class="nb">set</span><span class="p">(</span><span class="n">levels</span><span class="p">)</span> <span class="o">==</span> <span class="nb">set</span><span class="p">([</span><span class="kc">None</span><span class="p">,</span> <span class="mi">1</span><span class="p">])</span>

    <span class="c1"># bool special cases</span>
    <span class="n">t</span><span class="p">([</span><span class="s2">&quot;None&quot;</span><span class="p">,</span> <span class="s2">&quot;NaN&quot;</span><span class="p">],</span> <span class="p">[</span><span class="n">C</span><span class="p">([</span><span class="kc">True</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">,</span> <span class="kc">None</span><span class="p">])],</span>
      <span class="kc">True</span><span class="p">,</span> <span class="p">(</span><span class="kc">False</span><span class="p">,</span> <span class="kc">True</span><span class="p">))</span>
    <span class="n">t</span><span class="p">([],</span> <span class="p">[</span><span class="n">C</span><span class="p">([</span><span class="mi">10</span><span class="p">,</span> <span class="mi">20</span><span class="p">]),</span> <span class="n">C</span><span class="p">([</span><span class="kc">False</span><span class="p">]),</span> <span class="n">C</span><span class="p">([</span><span class="mi">30</span><span class="p">,</span> <span class="mi">40</span><span class="p">])],</span>
      <span class="kc">False</span><span class="p">,</span> <span class="p">(</span><span class="kc">False</span><span class="p">,</span> <span class="kc">True</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="mi">20</span><span class="p">,</span> <span class="mi">30</span><span class="p">,</span> <span class="mi">40</span><span class="p">))</span>
    <span class="c1"># exercise the fast-path</span>
    <span class="n">t</span><span class="p">([],</span> <span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">([</span><span class="kc">True</span><span class="p">,</span> <span class="kc">False</span><span class="p">]),</span> <span class="p">[</span><span class="s2">&quot;foo&quot;</span><span class="p">]],</span>
      <span class="kc">True</span><span class="p">,</span> <span class="p">(</span><span class="kc">False</span><span class="p">,</span> <span class="kc">True</span><span class="p">))</span>

    <span class="c1"># check tuples too</span>
    <span class="n">t</span><span class="p">([</span><span class="s2">&quot;None&quot;</span><span class="p">,</span> <span class="s2">&quot;NaN&quot;</span><span class="p">],</span> <span class="p">[</span><span class="n">C</span><span class="p">([(</span><span class="s2">&quot;b&quot;</span><span class="p">,</span> <span class="mi">2</span><span class="p">),</span> <span class="kc">None</span><span class="p">,</span> <span class="p">(</span><span class="s2">&quot;a&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">,</span> <span class="p">(</span><span class="s2">&quot;c&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)])],</span>
      <span class="kc">False</span><span class="p">,</span> <span class="p">((</span><span class="s2">&quot;a&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> <span class="p">(</span><span class="s2">&quot;b&quot;</span><span class="p">,</span> <span class="mi">2</span><span class="p">),</span> <span class="p">(</span><span class="s2">&quot;c&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)))</span>

    <span class="c1"># contrasts</span>
    <span class="n">t</span><span class="p">([],</span> <span class="p">[</span><span class="n">C</span><span class="p">([</span><span class="mi">10</span><span class="p">,</span> <span class="mi">20</span><span class="p">],</span> <span class="n">contrast</span><span class="o">=</span><span class="s2">&quot;FOO&quot;</span><span class="p">)],</span> <span class="kc">False</span><span class="p">,</span> <span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">20</span><span class="p">),</span> <span class="s2">&quot;FOO&quot;</span><span class="p">)</span>

    <span class="c1"># no box</span>
    <span class="n">t</span><span class="p">([],</span> <span class="p">[[</span><span class="mi">10</span><span class="p">,</span> <span class="mi">30</span><span class="p">],</span> <span class="p">[</span><span class="mi">20</span><span class="p">]],</span> <span class="kc">False</span><span class="p">,</span> <span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">20</span><span class="p">,</span> <span class="mi">30</span><span class="p">))</span>
    <span class="n">t</span><span class="p">([],</span> <span class="p">[[</span><span class="s2">&quot;b&quot;</span><span class="p">,</span> <span class="s2">&quot;a&quot;</span><span class="p">],</span> <span class="p">[</span><span class="s2">&quot;a&quot;</span><span class="p">]],</span> <span class="kc">False</span><span class="p">,</span> <span class="p">(</span><span class="s2">&quot;a&quot;</span><span class="p">,</span> <span class="s2">&quot;b&quot;</span><span class="p">))</span>

    <span class="c1"># 0d</span>
    <span class="n">t</span><span class="p">([],</span> <span class="p">[</span><span class="s2">&quot;b&quot;</span><span class="p">],</span> <span class="kc">False</span><span class="p">,</span> <span class="p">(</span><span class="s2">&quot;b&quot;</span><span class="p">,))</span>

    <span class="kn">from</span> <span class="nn">nose.tools</span> <span class="k">import</span> <span class="n">assert_raises</span>

    <span class="c1"># unhashable level error:</span>
    <span class="n">sniffer</span> <span class="o">=</span> <span class="n">CategoricalSniffer</span><span class="p">(</span><span class="n">NAAction</span><span class="p">())</span>
    <span class="n">assert_raises</span><span class="p">(</span><span class="n">PatsyError</span><span class="p">,</span> <span class="n">sniffer</span><span class="o">.</span><span class="n">sniff</span><span class="p">,</span> <span class="p">[{}])</span>

    <span class="c1"># &gt;1d is illegal</span>
    <span class="n">assert_raises</span><span class="p">(</span><span class="n">PatsyError</span><span class="p">,</span> <span class="n">sniffer</span><span class="o">.</span><span class="n">sniff</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">([[</span><span class="s2">&quot;b&quot;</span><span class="p">]]))</span></div>

<span class="c1"># returns either a 1d ndarray or a pandas.Series</span>
<div class="viewcode-block" id="categorical_to_int"><a class="viewcode-back" href="../../generated/patsy.categorical.categorical_to_int.html#patsy.categorical.categorical_to_int">[docs]</a><span class="k">def</span> <span class="nf">categorical_to_int</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">levels</span><span class="p">,</span> <span class="n">NA_action</span><span class="p">,</span> <span class="n">origin</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">levels</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">)</span>
    <span class="c1"># In this function, missing values are always mapped to -1</span>

    <span class="k">if</span> <span class="n">safe_is_pandas_categorical</span><span class="p">(</span><span class="n">data</span><span class="p">):</span>
        <span class="n">data_levels_tuple</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">pandas_Categorical_categories</span><span class="p">(</span><span class="n">data</span><span class="p">))</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">data_levels_tuple</span> <span class="o">==</span> <span class="n">levels</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">PatsyError</span><span class="p">(</span><span class="s2">&quot;mismatching levels: expected </span><span class="si">%r</span><span class="s2">, got </span><span class="si">%r</span><span class="s2">&quot;</span>
                             <span class="o">%</span> <span class="p">(</span><span class="n">levels</span><span class="p">,</span> <span class="n">data_levels_tuple</span><span class="p">),</span> <span class="n">origin</span><span class="p">)</span>
        <span class="c1"># pandas.Categorical also uses -1 to indicate NA, and we don&#39;t try to</span>
        <span class="c1"># second-guess its NA detection, so we can just pass it back.</span>
        <span class="k">return</span> <span class="n">pandas_Categorical_codes</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>

    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">_CategoricalBox</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">data</span><span class="o">.</span><span class="n">levels</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">levels</span><span class="p">)</span> <span class="o">!=</span> <span class="n">levels</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">PatsyError</span><span class="p">(</span><span class="s2">&quot;mismatching levels: expected </span><span class="si">%r</span><span class="s2">, got </span><span class="si">%r</span><span class="s2">&quot;</span>
                             <span class="o">%</span> <span class="p">(</span><span class="n">levels</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">levels</span><span class="p">)),</span> <span class="n">origin</span><span class="p">)</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">data</span>

    <span class="n">data</span> <span class="o">=</span> <span class="n">_categorical_shape_fix</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="n">level_to_int</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">levels</span><span class="p">,</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">levels</span><span class="p">))))</span>
    <span class="k">except</span> <span class="ne">TypeError</span><span class="p">:</span>
        <span class="k">raise</span> <span class="n">PatsyError</span><span class="p">(</span><span class="s2">&quot;Error interpreting categorical data: &quot;</span>
                         <span class="s2">&quot;all items must be hashable&quot;</span><span class="p">,</span> <span class="n">origin</span><span class="p">)</span>

    <span class="c1"># fastpath to avoid doing an item-by-item iteration over boolean arrays,</span>
    <span class="c1"># as requested by #44</span>
    <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="s2">&quot;dtype&quot;</span><span class="p">)</span> <span class="ow">and</span> <span class="n">safe_issubdtype</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">dtype</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">bool_</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">level_to_int</span><span class="p">[</span><span class="kc">False</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">level_to_int</span><span class="p">[</span><span class="kc">True</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">data</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">int_</span><span class="p">)</span>
    <span class="n">out</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">int</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">data</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">NA_action</span><span class="o">.</span><span class="n">is_categorical_NA</span><span class="p">(</span><span class="n">value</span><span class="p">):</span>
            <span class="n">out</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">out</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">level_to_int</span><span class="p">[</span><span class="n">value</span><span class="p">]</span>
            <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
                <span class="n">SHOW_LEVELS</span> <span class="o">=</span> <span class="mi">4</span>
                <span class="n">level_strs</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">levels</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="n">SHOW_LEVELS</span><span class="p">:</span>
                    <span class="n">level_strs</span> <span class="o">+=</span> <span class="p">[</span><span class="nb">repr</span><span class="p">(</span><span class="n">level</span><span class="p">)</span> <span class="k">for</span> <span class="n">level</span> <span class="ow">in</span> <span class="n">levels</span><span class="p">]</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">level_strs</span> <span class="o">+=</span> <span class="p">[</span><span class="nb">repr</span><span class="p">(</span><span class="n">level</span><span class="p">)</span>
                                   <span class="k">for</span> <span class="n">level</span> <span class="ow">in</span> <span class="n">levels</span><span class="p">[:</span><span class="n">SHOW_LEVELS</span><span class="o">//</span><span class="mi">2</span><span class="p">]]</span>
                    <span class="n">level_strs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;...&quot;</span><span class="p">)</span>
                    <span class="n">level_strs</span> <span class="o">+=</span> <span class="p">[</span><span class="nb">repr</span><span class="p">(</span><span class="n">level</span><span class="p">)</span>
                                   <span class="k">for</span> <span class="n">level</span> <span class="ow">in</span> <span class="n">levels</span><span class="p">[</span><span class="o">-</span><span class="n">SHOW_LEVELS</span><span class="o">//</span><span class="mi">2</span><span class="p">:]]</span>
                <span class="n">level_str</span> <span class="o">=</span> <span class="s2">&quot;[</span><span class="si">%s</span><span class="s2">]&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="s2">&quot;, &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">level_strs</span><span class="p">))</span>
                <span class="k">raise</span> <span class="n">PatsyError</span><span class="p">(</span><span class="s2">&quot;Error converting data to categorical: &quot;</span>
                                 <span class="s2">&quot;observation with value </span><span class="si">%r</span><span class="s2"> does not match &quot;</span>
                                 <span class="s2">&quot;any of the expected levels (expected: </span><span class="si">%s</span><span class="s2">)&quot;</span>
                                 <span class="o">%</span> <span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">level_str</span><span class="p">),</span> <span class="n">origin</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">TypeError</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">PatsyError</span><span class="p">(</span><span class="s2">&quot;Error converting data to categorical: &quot;</span>
                                 <span class="s2">&quot;encountered unhashable value </span><span class="si">%r</span><span class="s2">&quot;</span>
                                 <span class="o">%</span> <span class="p">(</span><span class="n">value</span><span class="p">,),</span> <span class="n">origin</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">have_pandas</span> <span class="ow">and</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">pandas</span><span class="o">.</span><span class="n">Series</span><span class="p">):</span>
        <span class="n">out</span> <span class="o">=</span> <span class="n">pandas</span><span class="o">.</span><span class="n">Series</span><span class="p">(</span><span class="n">out</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="n">data</span><span class="o">.</span><span class="n">index</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">out</span></div>

<div class="viewcode-block" id="test_categorical_to_int"><a class="viewcode-back" href="../../generated/patsy.categorical.test_categorical_to_int.html#patsy.categorical.test_categorical_to_int">[docs]</a><span class="k">def</span> <span class="nf">test_categorical_to_int</span><span class="p">():</span>
    <span class="kn">from</span> <span class="nn">nose.tools</span> <span class="k">import</span> <span class="n">assert_raises</span>
    <span class="kn">from</span> <span class="nn">patsy.missing</span> <span class="k">import</span> <span class="n">NAAction</span>
    <span class="k">if</span> <span class="n">have_pandas</span><span class="p">:</span>
        <span class="n">s</span> <span class="o">=</span> <span class="n">pandas</span><span class="o">.</span><span class="n">Series</span><span class="p">([</span><span class="s2">&quot;a&quot;</span><span class="p">,</span> <span class="s2">&quot;b&quot;</span><span class="p">,</span> <span class="s2">&quot;c&quot;</span><span class="p">],</span> <span class="n">index</span><span class="o">=</span><span class="p">[</span><span class="mi">10</span><span class="p">,</span> <span class="mi">20</span><span class="p">,</span> <span class="mi">30</span><span class="p">])</span>
        <span class="n">c_pandas</span> <span class="o">=</span> <span class="n">categorical_to_int</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="p">(</span><span class="s2">&quot;a&quot;</span><span class="p">,</span> <span class="s2">&quot;b&quot;</span><span class="p">,</span> <span class="s2">&quot;c&quot;</span><span class="p">),</span> <span class="n">NAAction</span><span class="p">())</span>
        <span class="k">assert</span> <span class="n">np</span><span class="o">.</span><span class="n">all</span><span class="p">(</span><span class="n">c_pandas</span> <span class="o">==</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">])</span>
        <span class="k">assert</span> <span class="n">np</span><span class="o">.</span><span class="n">all</span><span class="p">(</span><span class="n">c_pandas</span><span class="o">.</span><span class="n">index</span> <span class="o">==</span> <span class="p">[</span><span class="mi">10</span><span class="p">,</span> <span class="mi">20</span><span class="p">,</span> <span class="mi">30</span><span class="p">])</span>
        <span class="c1"># Input must be 1-dimensional</span>
        <span class="n">assert_raises</span><span class="p">(</span><span class="n">PatsyError</span><span class="p">,</span>
                      <span class="n">categorical_to_int</span><span class="p">,</span>
                      <span class="n">pandas</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">({</span><span class="mi">10</span><span class="p">:</span> <span class="n">s</span><span class="p">}),</span> <span class="p">(</span><span class="s2">&quot;a&quot;</span><span class="p">,</span> <span class="s2">&quot;b&quot;</span><span class="p">,</span> <span class="s2">&quot;c&quot;</span><span class="p">),</span> <span class="n">NAAction</span><span class="p">())</span>
    <span class="k">if</span> <span class="n">have_pandas_categorical</span><span class="p">:</span>
        <span class="n">constructors</span> <span class="o">=</span> <span class="p">[</span><span class="n">pandas_Categorical_from_codes</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">have_pandas_categorical_dtype</span><span class="p">:</span>
            <span class="k">def</span> <span class="nf">Series_from_codes</span><span class="p">(</span><span class="n">codes</span><span class="p">,</span> <span class="n">categories</span><span class="p">):</span>
                <span class="n">c</span> <span class="o">=</span> <span class="n">pandas_Categorical_from_codes</span><span class="p">(</span><span class="n">codes</span><span class="p">,</span> <span class="n">categories</span><span class="p">)</span>
                <span class="k">return</span> <span class="n">pandas</span><span class="o">.</span><span class="n">Series</span><span class="p">(</span><span class="n">c</span><span class="p">)</span>
            <span class="n">constructors</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">Series_from_codes</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">con</span> <span class="ow">in</span> <span class="n">constructors</span><span class="p">:</span>
            <span class="n">cat</span> <span class="o">=</span> <span class="n">con</span><span class="p">([</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="p">(</span><span class="s2">&quot;a&quot;</span><span class="p">,</span> <span class="s2">&quot;b&quot;</span><span class="p">))</span>
            <span class="n">conv</span> <span class="o">=</span> <span class="n">categorical_to_int</span><span class="p">(</span><span class="n">cat</span><span class="p">,</span> <span class="p">(</span><span class="s2">&quot;a&quot;</span><span class="p">,</span> <span class="s2">&quot;b&quot;</span><span class="p">),</span> <span class="n">NAAction</span><span class="p">())</span>
            <span class="k">assert</span> <span class="n">np</span><span class="o">.</span><span class="n">all</span><span class="p">(</span><span class="n">conv</span> <span class="o">==</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">])</span>
            <span class="c1"># Trust pandas NA marking</span>
            <span class="n">cat2</span> <span class="o">=</span> <span class="n">con</span><span class="p">([</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="p">(</span><span class="s2">&quot;a&quot;</span><span class="p">,</span> <span class="s2">&quot;None&quot;</span><span class="p">))</span>
            <span class="n">conv2</span> <span class="o">=</span> <span class="n">categorical_to_int</span><span class="p">(</span><span class="n">cat</span><span class="p">,</span> <span class="p">(</span><span class="s2">&quot;a&quot;</span><span class="p">,</span> <span class="s2">&quot;b&quot;</span><span class="p">),</span>
                                       <span class="n">NAAction</span><span class="p">(</span><span class="n">NA_types</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;None&quot;</span><span class="p">]))</span>
            <span class="k">assert</span> <span class="n">np</span><span class="o">.</span><span class="n">all</span><span class="p">(</span><span class="n">conv2</span> <span class="o">==</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">])</span>
            <span class="c1"># But levels must match</span>
            <span class="n">assert_raises</span><span class="p">(</span><span class="n">PatsyError</span><span class="p">,</span>
                          <span class="n">categorical_to_int</span><span class="p">,</span>
                          <span class="n">con</span><span class="p">([</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span> <span class="p">(</span><span class="s2">&quot;a&quot;</span><span class="p">,</span> <span class="s2">&quot;b&quot;</span><span class="p">)),</span>
                          <span class="p">(</span><span class="s2">&quot;a&quot;</span><span class="p">,</span> <span class="s2">&quot;c&quot;</span><span class="p">),</span>
                          <span class="n">NAAction</span><span class="p">())</span>
            <span class="n">assert_raises</span><span class="p">(</span><span class="n">PatsyError</span><span class="p">,</span>
                          <span class="n">categorical_to_int</span><span class="p">,</span>
                          <span class="n">con</span><span class="p">([</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span> <span class="p">(</span><span class="s2">&quot;a&quot;</span><span class="p">,</span> <span class="s2">&quot;b&quot;</span><span class="p">)),</span>
                          <span class="p">(</span><span class="s2">&quot;b&quot;</span><span class="p">,</span> <span class="s2">&quot;a&quot;</span><span class="p">),</span>
                          <span class="n">NAAction</span><span class="p">())</span>

    <span class="k">def</span> <span class="nf">t</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">levels</span><span class="p">,</span> <span class="n">expected</span><span class="p">,</span> <span class="n">NA_action</span><span class="o">=</span><span class="n">NAAction</span><span class="p">()):</span>
        <span class="n">got</span> <span class="o">=</span> <span class="n">categorical_to_int</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">levels</span><span class="p">,</span> <span class="n">NA_action</span><span class="p">)</span>
        <span class="k">assert</span> <span class="n">np</span><span class="o">.</span><span class="n">array_equal</span><span class="p">(</span><span class="n">got</span><span class="p">,</span> <span class="n">expected</span><span class="p">)</span>

    <span class="n">t</span><span class="p">([</span><span class="s2">&quot;a&quot;</span><span class="p">,</span> <span class="s2">&quot;b&quot;</span><span class="p">,</span> <span class="s2">&quot;a&quot;</span><span class="p">],</span> <span class="p">(</span><span class="s2">&quot;a&quot;</span><span class="p">,</span> <span class="s2">&quot;b&quot;</span><span class="p">),</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">])</span>
    <span class="n">t</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">([</span><span class="s2">&quot;a&quot;</span><span class="p">,</span> <span class="s2">&quot;b&quot;</span><span class="p">,</span> <span class="s2">&quot;a&quot;</span><span class="p">]),</span> <span class="p">(</span><span class="s2">&quot;a&quot;</span><span class="p">,</span> <span class="s2">&quot;b&quot;</span><span class="p">),</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">])</span>
    <span class="n">t</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">([</span><span class="s2">&quot;a&quot;</span><span class="p">,</span> <span class="s2">&quot;b&quot;</span><span class="p">,</span> <span class="s2">&quot;a&quot;</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">object</span><span class="p">),</span> <span class="p">(</span><span class="s2">&quot;a&quot;</span><span class="p">,</span> <span class="s2">&quot;b&quot;</span><span class="p">),</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">])</span>
    <span class="n">t</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">],</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span> <span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">])</span>
    <span class="n">t</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">]),</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span> <span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">])</span>
    <span class="n">t</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">),</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span> <span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">])</span>
    <span class="n">t</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">object</span><span class="p">),</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span> <span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">])</span>
    <span class="n">t</span><span class="p">([</span><span class="s2">&quot;a&quot;</span><span class="p">,</span> <span class="s2">&quot;b&quot;</span><span class="p">,</span> <span class="s2">&quot;a&quot;</span><span class="p">],</span> <span class="p">(</span><span class="s2">&quot;a&quot;</span><span class="p">,</span> <span class="s2">&quot;d&quot;</span><span class="p">,</span> <span class="s2">&quot;z&quot;</span><span class="p">,</span> <span class="s2">&quot;b&quot;</span><span class="p">),</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">0</span><span class="p">])</span>
    <span class="n">t</span><span class="p">([(</span><span class="s2">&quot;a&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> <span class="p">(</span><span class="s2">&quot;b&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span> <span class="p">(</span><span class="s2">&quot;a&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)],</span> <span class="p">((</span><span class="s2">&quot;a&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> <span class="p">(</span><span class="s2">&quot;b&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)),</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">])</span>

    <span class="n">assert_raises</span><span class="p">(</span><span class="n">PatsyError</span><span class="p">,</span> <span class="n">categorical_to_int</span><span class="p">,</span>
                  <span class="p">[</span><span class="s2">&quot;a&quot;</span><span class="p">,</span> <span class="s2">&quot;b&quot;</span><span class="p">,</span> <span class="s2">&quot;a&quot;</span><span class="p">],</span> <span class="p">(</span><span class="s2">&quot;a&quot;</span><span class="p">,</span> <span class="s2">&quot;c&quot;</span><span class="p">),</span> <span class="n">NAAction</span><span class="p">())</span>

    <span class="n">t</span><span class="p">(</span><span class="n">C</span><span class="p">([</span><span class="s2">&quot;a&quot;</span><span class="p">,</span> <span class="s2">&quot;b&quot;</span><span class="p">,</span> <span class="s2">&quot;a&quot;</span><span class="p">]),</span> <span class="p">(</span><span class="s2">&quot;a&quot;</span><span class="p">,</span> <span class="s2">&quot;b&quot;</span><span class="p">),</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">])</span>
    <span class="n">t</span><span class="p">(</span><span class="n">C</span><span class="p">([</span><span class="s2">&quot;a&quot;</span><span class="p">,</span> <span class="s2">&quot;b&quot;</span><span class="p">,</span> <span class="s2">&quot;a&quot;</span><span class="p">]),</span> <span class="p">(</span><span class="s2">&quot;b&quot;</span><span class="p">,</span> <span class="s2">&quot;a&quot;</span><span class="p">),</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">])</span>
    <span class="n">t</span><span class="p">(</span><span class="n">C</span><span class="p">([</span><span class="s2">&quot;a&quot;</span><span class="p">,</span> <span class="s2">&quot;b&quot;</span><span class="p">,</span> <span class="s2">&quot;a&quot;</span><span class="p">],</span> <span class="n">levels</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;b&quot;</span><span class="p">,</span> <span class="s2">&quot;a&quot;</span><span class="p">]),</span> <span class="p">(</span><span class="s2">&quot;b&quot;</span><span class="p">,</span> <span class="s2">&quot;a&quot;</span><span class="p">),</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">])</span>
    <span class="c1"># Mismatch between C() levels and expected levels</span>
    <span class="n">assert_raises</span><span class="p">(</span><span class="n">PatsyError</span><span class="p">,</span> <span class="n">categorical_to_int</span><span class="p">,</span>
                  <span class="n">C</span><span class="p">([</span><span class="s2">&quot;a&quot;</span><span class="p">,</span> <span class="s2">&quot;b&quot;</span><span class="p">,</span> <span class="s2">&quot;a&quot;</span><span class="p">],</span> <span class="n">levels</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;a&quot;</span><span class="p">,</span> <span class="s2">&quot;b&quot;</span><span class="p">]),</span>
                  <span class="p">(</span><span class="s2">&quot;b&quot;</span><span class="p">,</span> <span class="s2">&quot;a&quot;</span><span class="p">),</span> <span class="n">NAAction</span><span class="p">())</span>

    <span class="c1"># ndim == 0 is okay</span>
    <span class="n">t</span><span class="p">(</span><span class="s2">&quot;a&quot;</span><span class="p">,</span> <span class="p">(</span><span class="s2">&quot;a&quot;</span><span class="p">,</span> <span class="s2">&quot;b&quot;</span><span class="p">),</span> <span class="p">[</span><span class="mi">0</span><span class="p">])</span>
    <span class="n">t</span><span class="p">(</span><span class="s2">&quot;b&quot;</span><span class="p">,</span> <span class="p">(</span><span class="s2">&quot;a&quot;</span><span class="p">,</span> <span class="s2">&quot;b&quot;</span><span class="p">),</span> <span class="p">[</span><span class="mi">1</span><span class="p">])</span>
    <span class="n">t</span><span class="p">(</span><span class="kc">True</span><span class="p">,</span> <span class="p">(</span><span class="kc">False</span><span class="p">,</span> <span class="kc">True</span><span class="p">),</span> <span class="p">[</span><span class="mi">1</span><span class="p">])</span>

    <span class="c1"># ndim == 2 is disallowed</span>
    <span class="n">assert_raises</span><span class="p">(</span><span class="n">PatsyError</span><span class="p">,</span> <span class="n">categorical_to_int</span><span class="p">,</span>
                  <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">([[</span><span class="s2">&quot;a&quot;</span><span class="p">,</span> <span class="s2">&quot;b&quot;</span><span class="p">],</span> <span class="p">[</span><span class="s2">&quot;b&quot;</span><span class="p">,</span> <span class="s2">&quot;a&quot;</span><span class="p">]]),</span>
                  <span class="p">(</span><span class="s2">&quot;a&quot;</span><span class="p">,</span> <span class="s2">&quot;b&quot;</span><span class="p">),</span> <span class="n">NAAction</span><span class="p">())</span>

    <span class="c1"># levels must be hashable</span>
    <span class="n">assert_raises</span><span class="p">(</span><span class="n">PatsyError</span><span class="p">,</span> <span class="n">categorical_to_int</span><span class="p">,</span>
                  <span class="p">[</span><span class="s2">&quot;a&quot;</span><span class="p">,</span> <span class="s2">&quot;b&quot;</span><span class="p">],</span> <span class="p">(</span><span class="s2">&quot;a&quot;</span><span class="p">,</span> <span class="s2">&quot;b&quot;</span><span class="p">,</span> <span class="p">{}),</span> <span class="n">NAAction</span><span class="p">())</span>
    <span class="n">assert_raises</span><span class="p">(</span><span class="n">PatsyError</span><span class="p">,</span> <span class="n">categorical_to_int</span><span class="p">,</span>
                  <span class="p">[</span><span class="s2">&quot;a&quot;</span><span class="p">,</span> <span class="s2">&quot;b&quot;</span><span class="p">,</span> <span class="p">{}],</span> <span class="p">(</span><span class="s2">&quot;a&quot;</span><span class="p">,</span> <span class="s2">&quot;b&quot;</span><span class="p">),</span> <span class="n">NAAction</span><span class="p">())</span>

    <span class="n">t</span><span class="p">([</span><span class="s2">&quot;b&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">,</span> <span class="s2">&quot;a&quot;</span><span class="p">],</span> <span class="p">(</span><span class="s2">&quot;a&quot;</span><span class="p">,</span> <span class="s2">&quot;b&quot;</span><span class="p">),</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span>
      <span class="n">NAAction</span><span class="p">(</span><span class="n">NA_types</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;None&quot;</span><span class="p">,</span> <span class="s2">&quot;NaN&quot;</span><span class="p">]))</span>
    <span class="n">t</span><span class="p">([</span><span class="s2">&quot;b&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">,</span> <span class="s2">&quot;a&quot;</span><span class="p">],</span> <span class="p">(</span><span class="s2">&quot;a&quot;</span><span class="p">,</span> <span class="s2">&quot;b&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">),</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span>
      <span class="n">NAAction</span><span class="p">(</span><span class="n">NA_types</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;None&quot;</span><span class="p">,</span> <span class="s2">&quot;NaN&quot;</span><span class="p">]))</span>
    <span class="n">t</span><span class="p">([</span><span class="s2">&quot;b&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">,</span> <span class="s2">&quot;a&quot;</span><span class="p">],</span> <span class="p">(</span><span class="s2">&quot;a&quot;</span><span class="p">,</span> <span class="s2">&quot;b&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">),</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span>
      <span class="n">NAAction</span><span class="p">(</span><span class="n">NA_types</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;NaN&quot;</span><span class="p">]))</span>

    <span class="c1"># Smoke test for the branch that formats the ellipsized list of levels in</span>
    <span class="c1"># the error message:</span>
    <span class="n">assert_raises</span><span class="p">(</span><span class="n">PatsyError</span><span class="p">,</span> <span class="n">categorical_to_int</span><span class="p">,</span>
                  <span class="p">[</span><span class="s2">&quot;a&quot;</span><span class="p">,</span> <span class="s2">&quot;b&quot;</span><span class="p">,</span> <span class="s2">&quot;q&quot;</span><span class="p">],</span>
                  <span class="p">(</span><span class="s2">&quot;a&quot;</span><span class="p">,</span> <span class="s2">&quot;b&quot;</span><span class="p">,</span> <span class="s2">&quot;c&quot;</span><span class="p">,</span> <span class="s2">&quot;d&quot;</span><span class="p">,</span> <span class="s2">&quot;e&quot;</span><span class="p">,</span> <span class="s2">&quot;f&quot;</span><span class="p">,</span> <span class="s2">&quot;g&quot;</span><span class="p">,</span> <span class="s2">&quot;h&quot;</span><span class="p">),</span>
                  <span class="n">NAAction</span><span class="p">())</span></div>
</pre></div>

           </div>
          </div>
          <footer>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright 2016.

    </p>
  </div>
  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/snide/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  


  

    <script type="text/javascript">
        var DOCUMENTATION_OPTIONS = {
            URL_ROOT:'../../',
            VERSION:'1',
            COLLAPSE_INDEX:false,
            FILE_SUFFIX:'.html',
            HAS_SOURCE:  true
        };
    </script>
      <script type="text/javascript" src="../../_static/jquery.js"></script>
      <script type="text/javascript" src="../../_static/underscore.js"></script>
      <script type="text/javascript" src="../../_static/doctools.js"></script>
      <script type="text/javascript" src="https://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>

  

  
  
    <script type="text/javascript" src="../../_static/js/theme.js"></script>
  

  
  
  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.StickyNav.enable();
      });
  </script>
   

</body>
</html>